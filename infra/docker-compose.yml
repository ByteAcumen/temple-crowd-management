version: '3.8'

services:
  # MongoDB Database
  mongodb:
    image: mongo:6.0
    container_name: temple-mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: temple123
      MONGO_INITDB_DATABASE: temple_crowd_management
    volumes:
      - mongodb_data:/data/db
    networks:
      - temple-network

  # Redis Cache
  redis:
    image: redis:7.0-alpine
    container_name: temple-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - temple-network

  # RabbitMQ Message Queue
  rabbitmq:
    image: rabbitmq:3.12-management
    container_name: temple-rabbitmq
    restart: always
    ports:
      - "5672:5672"   # AMQP port
      - "15672:15672" # Management UI
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: temple123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - temple-network

  # Backend API
  backend:
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: temple-backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      NODE_ENV: development
      PORT: 5000
      MONGODB_URI: mongodb://admin:temple123@mongodb:27017/temple_crowd_management?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:temple123@rabbitmq:5672
      JWT_SECRET: dev_secret_key_change_in_production
      ML_DETECTION_URL: http://ml-detection:8001
      ML_FORECASTING_URL: http://ml-forecasting:8002
      ML_ANOMALY_URL: http://ml-anomaly:8003
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    volumes:
      - ../backend:/app
      - /app/node_modules
    networks:
      - temple-network

  # ML Detection Service
  ml-detection:
    build:
      context: ../ml-services/crowd-detection
      dockerfile: Dockerfile
    container_name: temple-ml-detection
    restart: always
    ports:
      - "8001:8001"
    environment:
      RABBITMQ_URL: amqp://admin:temple123@rabbitmq:5672
      MONGODB_URI: mongodb://admin:temple123@mongodb:27017/temple_crowd_management?authSource=admin
    depends_on:
      - rabbitmq
    volumes:
      - ../ml-services/crowd-detection:/app
      - ml_models:/app/models
    networks:
      - temple-network
    # Uncomment if you have GPU
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: 1
    #           capabilities: [gpu]

  # ML Forecasting Service
  ml-forecasting:
    build:
      context: ../ml-services/crowd-forecasting
      dockerfile: Dockerfile
    container_name: temple-ml-forecasting
    restart: always
    ports:
      - "8002:8002"
    environment:
      MONGODB_URI: mongodb://admin:temple123@mongodb:27017/temple_crowd_management?authSource=admin
    depends_on:
      - mongodb
    volumes:
      - ../ml-services/crowd-forecasting:/app
      - ml_models:/app/models
    networks:
      - temple-network

  # Frontend (Development)
  frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.dev
    container_name: temple-frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      REACT_APP_API_URL: http://localhost:5000/api/v1
      REACT_APP_WS_URL: ws://localhost:5000
    depends_on:
      - backend
    volumes:
      - ../frontend:/app
      - /app/node_modules
    networks:
      - temple-network
    stdin_open: true
    tty: true

networks:
  temple-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  ml_models:
