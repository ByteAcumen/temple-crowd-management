const express = require('express');
const router = express.Router();

// Import middleware
const { protect, authorize } = require('../middleware/auth');

// Import controller functions
const {
    createTemple,
    getAllTemples,
    getTemple,
    updateTemple,
    deleteTemple,
    getTempleLiveStatus
} = require('../controllers/templeController');

/**
 * TEMPLE ROUTES
 * 
 * This file maps URLs to controller functions
 * Think of it as a "directory" that tells Express:
 * "When someone goes to /api/v1/temples, run getAllTemples function"
 * 
 * ROUTE PROTECTION:
 * - Public routes: Anyone can access
 * - protect: Requires login (JWT token)
 * - authorize('admin'): Requires admin role
 */

// Debug middleware
router.use((req, res, next) => {
    console.log(`[TempleRoutes] ${req.method} ${req.path}`);
    next();
});

router.get('/test', (req, res) => {
    res.json({ message: 'Temple Test Route OK' });
});

// ==========================================
// BASE ROUTE: /api/v1/temples
// ==========================================
router.route('/')
    // GET all temples (Public - anyone can view temples)
    .get(getAllTemples)

    // POST create new temple (Admin only)
    .post(protect, authorize('admin'), createTemple);

// ==========================================
// SINGLE TEMPLE: /api/v1/temples/:id
// ==========================================
// ==========================================
// PREDICTIONS: /api/v1/temples/:id/predictions
// ==========================================
// GET crowd predictions and recommendations
const templeStatusService = require('../services/TempleStatusService');
router.get('/:id/predictions', async (req, res) => {
    try {
        console.log('ðŸ”® Fetching predictions for:', req.params.id);
        const predictions = await templeStatusService.getTemplePredictions(req.params.id);
        res.json({ success: true, data: predictions });
    } catch (error) {
        console.error('âŒ Prediction Error:', error);
        res.status(404).json({ success: false, message: error.message });
    }
});

// ==========================================
// SINGLE TEMPLE: /api/v1/temples/:id
// ==========================================
// ==========================================
// SINGLE TEMPLE: /api/v1/temples/:id
// ==========================================
router.route('/:id')
    // GET one temple (Public - anyone can view)
    .get(getTemple)

    // PUT update temple (Admin only)
    .put(protect, authorize('admin'), updateTemple)

    // DELETE remove temple (Admin only)
    .delete(protect, authorize('admin'), deleteTemple);

// ==========================================
// AUTO-STATUS UPDATE: /api/v1/temples/sync-status
// ==========================================
// POST trigger manual status sync (Admin only)
router.post('/sync-status', protect, authorize('admin'), async (req, res) => {
    try {
        const results = await templeStatusService.updateAllTemplesStatus();
        res.json({ success: true, message: 'Temple statuses synchronized', data: results });
    } catch (error) {
        res.status(500).json({ success: false, message: error.message });
    }
});

/**
 * HOW THIS WORKS:
 * 
 * 1. User visits: GET /api/v1/temples
 *    â†’ Runs getAllTemples (no login required)
 * 
 * 2. Admin posts: POST /api/v1/temples
 *    â†’ protect checks JWT token
 *    â†’ authorize checks if user.role === 'admin'
 *    â†’ If both pass, runs createTemple
 * 
 * 3. Public visits: GET /api/v1/temples/123abc/live
 *    â†’ Runs getTempleLiveStatus (shows crowd % and traffic light)
 * 
 * MIDDLEWARE ORDER MATTERS:
 * protect comes before authorize (must login before checking role)
 */

module.exports = router;
